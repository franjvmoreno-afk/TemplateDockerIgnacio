[mysqld]
# Configuración del servidor MySQL orientada a Moodle

# Ajustes de base de datos
default-storage-engine=InnoDB          # Motor por defecto, más fiable para Moodle
character-set-server=utf8mb4           # Soporte completo de caracteres (emojis incluidos)
collation-server=utf8mb4_unicode_ci    # Comparación de texto compatible con UTF-8
skip-character-set-client-handshake    # Fuerza el charset del servidor

# Ajustes de conexión
max_connections=200                    # Número máximo de conexiones simultáneas
max_allowed_packet=64M                 # Tamaño máximo de paquetes enviados
connect_timeout=10                     # Tiempo máximo para conectar
wait_timeout=28800                     # Tiempo antes de cerrar conexiones inactivas
max_connect_errors=100                 # Límite de errores antes de bloquear host

# Caché de tablas
table_open_cache=4000                  # Tablas abiertas en caché
table_definition_cache=2000            # Definiciones de tablas en memoria

# Optimización de consultas
query_cache_type=0                     # Caché de consultas desactivada (obsoleta)
query_cache_size=0                     # Evita uso de memoria innecesario

# Ajustes InnoDB (recomendados para Moodle)
innodb_buffer_pool_size=1G             # Memoria principal para datos e índices
innodb_log_file_size=256M              # Tamaño de los logs de transacciones
innodb_file_per_table=1                # Un archivo por tabla
innodb_flush_log_at_trx_commit=2       # Mejor rendimiento con riesgo mínimo
innodb_flush_method=O_DIRECT           # Evita doble caché con el sistema
innodb_lock_wait_timeout=50            # Tiempo máximo de espera por bloqueos

# Esquema de rendimiento
performance_schema=ON                  # Activa métricas internas
performance_schema_max_table_instances=12500  # Límite de tablas monitorizadas

# Logs
log_error=/var/log/mysql/error.log      # Registro de errores del servidor
slow_query_log=1                       # Activa log de consultas lentas
slow_query_log_file=/var/log/mysql/slow.log  # Archivo de consultas lentas
long_query_time=2                      # Umbral para considerar una consulta lenta

# Binlog (replicación / copias)
log_bin=/var/log/mysql/mysql-bin.log    # Log binario habilitado
binlog_format=ROW                      # Formato más seguro para replicación
server_id=1                            # Identificador único del servidor
expire_logs_days=10                    # Limpieza automática de binlogs antiguos

# Ajustes de hilos
thread_stack=192K                      # Memoria por hilo
thread_cache_size=16                   # Reutilización de hilos

# Optimizaciones específicas para Moodle
tmp_table_size=32M                     # Tamaño de tablas temporales en memoria
max_heap_table_size=32M                # Límite para tablas HEAP
sort_buffer_size=2M                    # Buffer para ordenaciones
read_buffer_size=2M                    # Buffer de lectura secuencial
read_rnd_buffer_size=8M                # Buffer para lecturas aleatorias
join_buffer_size=2M                    # Buffer para joins sin índice

[mysqldump]
quick                                 # Volcado rápido de datos
quote-names                           # Escapa nombres de tablas
max_allowed_packet=64M                # Tamaño máximo de paquetes
default-character-set=utf8mb4         # Charset por defecto en backups

[mysql]
default-character-set=utf8mb4         # Charset por defecto del cliente mysql

[client]
default-character-set=utf8mb4         # Charset por defecto para clientes
port=3306                             # Puerto estándar de MySQL
